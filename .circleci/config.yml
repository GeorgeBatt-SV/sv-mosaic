version: 2.1
orbs:
  node: circleci/node@5.0.2

jobs:
  build:
    docker:
      - image: cimg/base:2021.04
        name: build
    resource_class: large
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
          version: 20.10.14
      - run:
          name: Build Mosaic Docker image
          command: |
            DOCKER_BUILDKIT=1 \
            docker build \
            -t "sv-mosaic" \
            .
      - run:
          name: Save Mosaic Docker image
          command: |
            docker save \
            -o sv_mosaic_build.tar \
            sv-mosaic
      - persist_to_workspace:
          root: ~/project
          paths:
            - .
  unit_tests:
    docker:
      - image: cimg/base:2021.04
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/project
      - setup_remote_docker:
          docker_layer_caching: true
          version: 20.10.14
      - run:
          name: Load Docker image
          command: |
            docker load \
            -i \
            sv_mosaic_build.tar
      - run:
          name: Spin up container and run unit tests
          command: |
            docker run \
            sv-mosaic \
            yarn test
  storybook:
    docker:
      - image: cimg/base:2021.04
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/project
      - setup_remote_docker:
          docker_layer_caching: true
          version: 20.10.14
      # - add_ssh_keys:
      #     fingerprints:
      #       - 90:c4:82:92:d0:82:28:9d:f4:c9:d0:25:27:1e:07:50
      - run:
          name: List .ssh dir
          command: ls -la ~/.ssh
      - run:
          name: Load Mosaic Docker image
          command: |
            docker load \
            -i \
            sv_mosaic_build.tar
      - run:
          name: Spin up container and publish to GitHub pages
          command: |
            docker run \
            -v ~/.ssh:/root/.ssh \
            sv-mosaic \
            head -c 20 /root/.ssh/authorized_keys
      # - run:
      #     name: Add github to known_hosts
      #     command: ssh-keyscan github.com >> ~/.ssh/known_hosts
      # - run:
      #     name: Publish storybook
      #     command: yarn run ci:storybook
      #     environment:
      #       NODE_DEBUG: gh-pages

# workflows:
#   build:
#     jobs:
#       - build:
#           context: default
#           filters:
#             branches:
#               only:
#                 - develop
#                 - /pull.*/
#       - unit_tests:
#           context: default
#           requires:
#             - build
#           filters:
#             branches:
#               only:
#                 - develop
#                 - /pull.*/
#       - storybook:
#           context: default
#           filters:
#             branches:
#               only:
#                 - develop
#                 - /pull.*/
#           requires:
#             - unit_tests

workflows:
  build:
    jobs:
      - build:
          context: default
          filters:
            branches:
              only:
                - develop
                - /pull.*/
      # - unit_tests:
      #     context: default
      #     requires:
      #       - build
      #     filters:
      #       branches:
      #         only:
      #           - develop
      #           - /pull.*/
      - storybook:
          context: default
          requires:
            - build
          filters:
            branches:
              only:
                - develop
                - /pull.*/
